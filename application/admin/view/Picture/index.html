<div class="row">
  <div class="col-md-2 text-right">
      <label>图片</label>
  </div>
  <div class="col-md-3">
    <input id="file" class="inputfile" type="file" nv-file-select="" uploader="uploader" multiple  />
    <label for="file" class="btn"><i class="glyphicon glyphicon-cloud-upload"></i> 上传图片 </label>
  </div>
</div>
<br>

<div class="row" ng-show="InfoShow">
  <div class="col-md-8 col-md-offset-2">
    <table class="table">
        <thead>
            <tr>
                <th width="50%">名称</th>
                <th ng-show="uploader.isHTML5">尺寸</th>
                <th ng-show="uploader.isHTML5">进度</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="item in uploader.queue">
                <td>
                    <strong>{{ item.file.name }}</strong>
                    <!-- Image preview -->
                    <!--auto height-->
                    <!--<div ng-thumb="{ file: item.file, width: 100 }"></div>-->
                    <!--auto width-->
                    <div ng-show="uploader.isHTML5" ng-thumb="{ file: item._file, height: 100 }"></div>
                    <!--fixed width and height -->
                    <!--<div ng-thumb="{ file: item.file, width: 100, height: 100 }"></div>-->
                </td>
                <td ng-show="uploader.isHTML5" nowrap>{{ item.file.size/1024/1024|number:2 }} MB</td>
                <td ng-show="uploader.isHTML5">
                    <div class="progress" style="margin-bottom: 0;">
                        <div class="progress-bar" role="progressbar" ng-style="{ 'width': item.progress + '%' }"></div>
                    </div>
                </td>
                <td class="text-center">
                    <span ng-show="item.isSuccess"><i class="glyphicon glyphicon-ok"></i></span>
                    <span ng-show="item.isCancel"><i class="glyphicon glyphicon-ban-circle"></i></span>
                    <span ng-show="item.isError"><i class="glyphicon glyphicon-remove"></i></span>
                </td>
                <td nowrap>
                    <button type="button" class="btn btn-success btn-xs" ng-click="item.upload()" ng-disabled="item.isReady || item.isUploading || item.isSuccess">
                        <span class="glyphicon glyphicon-upload"></span> 上传
                    </button>
                    <button type="button" class="btn btn-danger btn-xs" ng-click="delete(item)">
                        <span class="glyphicon glyphicon-trash"></span> 删除
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
    <div>
        <div>
            总进度:
            <div class="progress" style="">
                <div class="progress-bar" role="progressbar" ng-style="{ 'width': uploader.progress + '%' }"></div>
            </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <button type="button" class="btn btn-success btn-s" ng-click="uploader.uploadAll()" ng-disabled="!uploader.getNotUploadedItems().length"
            >
                <span class="glyphicon glyphicon-upload"></span> 全部上传
            </button>
            <button type="button" class="btn btn-danger btn-s" ng-click="deleteAllPicture()" ng-disabled="!uploader.queue.length">
                <span class="glyphicon glyphicon-trash"></span> 全部删除
            </button>
          </div>
          <div class="col-md-6 text-right">
            <label>文件总数：{{ uploader.queue.length }}</label>
          </div>
        <div>
    </div>
    <br><br><br>
  </div>
</div>
  </div>
<hr>
<div ng-show="hidden">
  <input type="text" ng-model="pictureIds" name="pictureIds"/>
</div>
</div>


<script>
app.controller('AppController', ['$scope', '$http', 'FileUploader', function($scope, $http, FileUploader) {

  //上传所有图片的id
  $scope.pictureIds = new Array();

  //定义remove方法，删除数组中指定的元素
  Array.prototype.remove = function(val) {
    var index = this.indexOf(val);
    if (index > -1) {
        this.splice(index, 1);
    }
  };

  $scope.submit = function() {
    //提交前将图片id数组转化为json字符串
    $scope.pictureIds = JSON.stringify($scope.pictureIds);
  };
  //删除图片
  $scope.delete = function (item) {
    //删除图片
    item.remove();
    tempFileName.remove(item.file.name);
    //删除数据库中的图片，根据图片名称删除图片，故上传图片名称不能一样
    var getData = {params: {name: item.file.name}};
    $http
    .get('{:url("picture/delete")}', getData)
    .then(function successCallback(response) {
      //删除上传的图片id
      $scope.pictureIds.remove(response.data);

    }, function errorCallback(response) {
      // called asynchronously if an error occurs
      // or server returns response with an error status.
    });

    //判断是否有图片，若不存在，则不显示图片信息
    if ($scope.uploader.queue.length === 0) {
      $scope.InfoShow = false;
    }
    
  };


  //删除所有图片
  $scope.deleteAllPicture = function () {
    var length = $scope.uploader.queue.length;
    for ($i = 0; $i < length; $i++) {
      $scope.delete($scope.uploader.queue[0]);
    }
  }

  var uploader = $scope.uploader = new FileUploader({
    url: '{:url("picture/upload")}'
  });

  // FILTERS

  uploader.filters.push({
    name: 'imageFilter',
    fn: function(item /*{File|FileLikeObject}*/, options) {
        var type = '|' + item.type.slice(item.type.lastIndexOf('/') + 1) + '|';
        return '|jpg|png|jpeg|bmp|gif|'.indexOf(type) !== -1;
    }
  });

  // CALLBACKS

  uploader.onWhenAddingFileFailed = function(item /*{File|FileLikeObject}*/, filter, options) {
      //console.info('onWhenAddingFileFailed', item, filter, options);
  };
  uploader.onAfterAddingFile = function(fileItem) {
      //请求所有图片名字，如果图片名字已存在，提示用户修改图片名字（图片名字不能重复，为删除图片做准备）
      $http({
        method: 'GET',
        url: '{:url("picture/getAllPictureNames")}'
      }).then(function (success){
      //获取所有图片名称
      var AllPictureNames = success.data;

      //如果图片已存在，提示用户修改图片名称
      if (AllPictureNames.indexOf(fileItem.file.name) !== -1) {
        $scope.uploader.queue.pop();
        alert('请修改图片名字，图片名字不能重复');
      }
     },function (error){
        alert('error');
     });
     //显示图片信息
     $scope.InfoShow = true;
     //console.info('onAfterAddingFile', fileItem);
  };

  //防止用户添加同名的图片
  var tempFileName = new Array();
  uploader.onAfterAddingAll = function(addedFileItems) {

      if (tempFileName.indexOf(addedFileItems[0].file.name) !== -1) {
        alert('对不起，不能上传同名的图片');
        $scope.uploader.queue.pop();
      } else {
        tempFileName.push(addedFileItems[0].file.name);
      }
      //console.info('onAfterAddingAll', addedFileItems);
  };
  uploader.onBeforeUploadItem = function(item) {

      //console.info('onBeforeUploadItem', item);
  };
  uploader.onProgressItem = function(fileItem, progress) {
      //console.info('onProgressItem', fileItem, progress);
  };
  uploader.onProgressAll = function(progress) {
      if (progress === 100) {
        $scope.progress = false;
      } else {
        $scope.progress = true;
      }
      //console.info('onProgressAll', progress);
  };
  uploader.onSuccessItem = function(fileItem, response, status, headers) {
      //console.info('onSuccessItem', fileItem, response, status, headers);
  };
  uploader.onErrorItem = function(fileItem, response, status, headers) {
      //console.info('onErrorItem', fileItem, response, status, headers);
  };
  uploader.onCancelItem = function(fileItem, response, status, headers) {
      //console.info('onCancelItem', fileItem, response, status, headers);
  };
  uploader.onCompleteItem = function(fileItem, response, status, headers) {
      //将上传的图片id添加到$scope.pictureIds数组中
      $scope.pictureIds.push(response);
      
      //console.info('onCompleteItem', fileItem, response, status, headers);
  };
  uploader.onCompleteAll = function() {
      //console.info('onCompleteAll');
  };

  //隐藏传输的图片id
  $scope.hidden = false;
  //console.info('uploader', uploader);
}]);
</script>

<script type="text/javascript">
//裁切图片
// Angular File Upload module does not include this directive
// Only for example


/**
* The ng-thumb directive
* @author: nerv
* @version: 0.1.2, 2014-01-09
*/
app.directive('ngThumb', ['$window', function($window) {
    var helper = {
        support: !!($window.FileReader && $window.CanvasRenderingContext2D),
        isFile: function(item) {
            return angular.isObject(item) && item instanceof $window.File;
        },
        isImage: function(file) {
            var type =  '|' + file.type.slice(file.type.lastIndexOf('/') + 1) + '|';
            return '|jpg|png|jpeg|bmp|gif|'.indexOf(type) !== -1;
        }
    };

    return {
        restrict: 'A',
        template: '<canvas/>',
        link: function(scope, element, attributes) {
            if (!helper.support) return;

            var params = scope.$eval(attributes.ngThumb);

            if (!helper.isFile(params.file)) return;
            if (!helper.isImage(params.file)) return;

            var canvas = element.find('canvas');
            var reader = new FileReader();

            reader.onload = onLoadFile;
            reader.readAsDataURL(params.file);

            function onLoadFile(event) {
                var img = new Image();
                img.onload = onLoadImage;
                img.src = event.target.result;
            }

            function onLoadImage() {
                var width = params.width || this.width / this.height * params.height;
                var height = params.height || this.height / this.width * params.width;
                canvas.attr({ width: width, height: height });
                canvas[0].getContext('2d').drawImage(this, 0, 0, width, height);
            }
        }
    };
}]);

</script>
<style>
/*设置“上传图片按钮”样式*/
.inputfile {
  width: 0.1px;
  height: 0.1px;
  opacity: 0;
  overflow: hidden;
  position: absolute;
  z-index: -1;
}

.inputfile + label {
    font-size: 1.25em;
    font-weight: 700;
    color: white;
    background-color: #d9534f;
    display: inline-block;
}

.inputfile:focus + label,
.inputfile + label:hover {
    background-color: #D10F0F;
    color: white;
}
.inputfile + label {
  cursor: pointer; /* "hand" cursor */
}
</style>